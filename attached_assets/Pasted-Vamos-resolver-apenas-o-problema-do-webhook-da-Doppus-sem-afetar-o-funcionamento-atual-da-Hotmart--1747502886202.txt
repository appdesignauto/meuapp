Vamos resolver apenas o problema do webhook da Doppus, sem afetar o funcionamento atual da Hotmart, que voc√™ j√° confirmou estar 100% est√°vel.

A solu√ß√£o abaixo √© eficiente, compat√≠vel com o Replit, e segura, sem leitura manual de stream, sem riscos de conflito com outras integra√ß√µes.

‚úÖ Objetivo
Garantir que o webhook da Doppus seja recebido corretamente no req.body

Manter o webhook da Hotmart e outros servi√ßos funcionando normalmente

Evitar o erro "stream is not readable"

‚úÖ Arquitetura recomendada
üîß server.js (N√ÉO MEXA no que j√° funciona, apenas certifique-se do seguinte)
js
Copiar
Editar
const express = require("express");
const app = express();

// Middleware global ‚Äî j√° deve estar presente
app.use(express.json()); // Para Hotmart e Doppus (application/json)
app.use(express.urlencoded({ extended: true })); // Para fallback tipo form

// Webhooks
const webhookHotmart = require("./routes/webhook-hotmart");
const webhookDoppus = require("./routes/webhook-doppus");

app.use("/webhook/hotmart", webhookHotmart);
app.use("/webhook/doppus", webhookDoppus);

// (restante da aplica√ß√£o continua igual)
‚úÖ Novo arquivo: routes/webhook-doppus.js
js
Copiar
Editar
const express = require("express");
const router = express.Router();

router.post("/", (req, res) => {
  try {
    const body = req.body;

    // Verifica√ß√£o m√≠nima
    if (!body || !body.customer || !body.items) {
      console.error("‚ùå Webhook malformado da Doppus");
      return res.status(400).json({ error: "Invalid payload" });
    }

    // ‚úÖ Sucesso no recebimento
    console.log("‚úÖ Webhook Doppus recebido com sucesso:");
    console.log(JSON.stringify(body, null, 2));

    res.status(200).json({ status: "ok" });
  } catch (err) {
    console.error("‚ùå Erro no webhook da Doppus:", err.message);
    res.status(500).json({ error: "Erro interno ao processar webhook" });
  }
});

module.exports = router;
üîç Observa√ß√µes importantes
N√£o tem leitura de stream manual, o que causava o erro "stream is not readable".

N√£o toca no webhook da Hotmart, que continua com express.json() normalmente.

Funciona para envios com Content-Type: application/json (padr√£o da Doppus).

Suporta envio de teste manual e simulado no Replit ou via plataforma Doppus.