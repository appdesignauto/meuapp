PLANO COMPLETO: INTEGRAÃ‡ÃƒO HOTMART + REPLIT (PRODUÃ‡ÃƒO)
ğŸ“ 1. .env â€” ConfiguraÃ§Ã£o das credenciais
No Replit, adicione no arquivo .env:

env
Copiar
Editar
HOTMART_SECRET=seu_hottok_da_hotmart
HOTMART_CLIENT_ID=seu_client_id
HOTMART_CLIENT_SECRET=seu_client_secret
âŒ NÃ£o coloque URL de webhook nem Basic Auth no .env

ğŸ§  2. utils/hotmart.js â€” FunÃ§Ã£o para obter token da API
js
Copiar
Editar
// utils/hotmart.js
const axios = require("axios");

async function getHotmartToken() {
  const basicAuth = Buffer.from(
    `${process.env.HOTMART_CLIENT_ID}:${process.env.HOTMART_CLIENT_SECRET}`
  ).toString("base64");

  try {
    const response = await axios.post(
      "https://api-hot-connect.hotmart.com/security/oauth/token",
      "grant_type=client_credentials",
      {
        headers: {
          Authorization: `Basic ${basicAuth}`,
          "Content-Type": "application/x-www-form-urlencoded",
        },
      }
    );
    return response.data.access_token;
  } catch (err) {
    console.error("Erro ao obter token da Hotmart:", err.response?.data || err.message);
    throw new Error("Falha ao gerar token da Hotmart");
  }
}

module.exports = { getHotmartToken };
ğŸŒ 3. routes/webhook.js â€” Rota para receber notificaÃ§Ãµes
js
Copiar
Editar
// routes/webhook.js
const express = require("express");
const crypto = require("crypto");
const router = express.Router();
const db = require("../db"); // ajuste ao seu banco
const { logWebhook } = require("../utils/logger");

router.post("/hotmart", express.json(), async (req, res) => {
  try {
    const receivedSignature = req.headers["x-hotmart-hottok"];
    const body = JSON.stringify(req.body);
    const calculatedSignature = crypto
      .createHmac("sha256", process.env.HOTMART_SECRET)
      .update(body)
      .digest("hex");

    if (receivedSignature !== calculatedSignature) {
      return res.status(403).send("Assinatura invÃ¡lida");
    }

    const payload = req.body;
    const email = payload?.buyer?.email;
    const status = payload?.subscription?.status;
    const hotmart_id = payload?.subscription?.purchase?.id;

    await logWebhook("hotmart", payload); // opcional para histÃ³rico

    if (!email) return res.status(400).send("E-mail ausente");

    if (status === "active") {
      await db.query(
        "UPDATE users SET plan = 'premium', plan_expiration = NOW() + interval '30 days', hotmart_purchase_id = $2 WHERE email = $1",
        [email, hotmart_id]
      );
    } else if (["canceled", "expired", "refunded"].includes(status)) {
      await db.query(
        "UPDATE users SET plan = 'free', plan_expiration = NULL WHERE email = $1",
        [email]
      );
    }

    res.send("OK");
  } catch (err) {
    console.error("Erro no webhook Hotmart:", err);
    res.status(500).send("Erro interno");
  }
});

module.exports = router;
ğŸ“Š 4. utils/logger.js â€” Logger opcional para auditoria
js
Copiar
Editar
const fs = require("fs");
const path = require("path");

function logWebhook(origin, payload) {
  const logPath = path.join(__dirname, "..", "webhook-logs.json");
  const logs = fs.existsSync(logPath) ? JSON.parse(fs.readFileSync(logPath)) : [];
  logs.push({ origin, timestamp: new Date().toISOString(), payload });
  fs.writeFileSync(logPath, JSON.stringify(logs, null, 2));
}

module.exports = { logWebhook };
ğŸ› ï¸ 5. server.js â€” Entradas no servidor principal
js
Copiar
Editar
const express = require("express");
require("dotenv").config();

const app = express();
const port = process.env.PORT || 3000;

const webhookRoutes = require("./routes/webhook");
app.use("/webhook", webhookRoutes);

app.get("/", (req, res) => res.send("DesignAuto API rodando ğŸš€"));
app.listen(port, () => console.log(`Servidor rodando na porta ${port}`));
ğŸ§ª 6. Painel â†’ BotÃ£o "Testar ConexÃ£o com Hotmart"
Acione manualmente a funÃ§Ã£o getHotmartToken() do hotmart.js. Se receber token com sucesso, estÃ¡ funcionando.

Exemplo:

js
Copiar
Editar
const { getHotmartToken } = require("./utils/hotmart");

app.get("/testar-hotmart", async (req, res) => {
  try {
    const token = await getHotmartToken();
    res.send(`Token gerado com sucesso: ${token.slice(0, 15)}...`);
  } catch (err) {
    res.status(500).send("Falha na conexÃ£o com a Hotmart");
  }
});
âœ… 7. Checklist final para produÃ§Ã£o
Etapa	Status
ğŸ” VariÃ¡veis de ambiente definidas	âœ…
ğŸŒ URL do webhook cadastrada na Hotmart	âœ…
ğŸ§  Token sendo gerado com sucesso	âœ…
ğŸ” Webhooks validados com Hottok	âœ…
ğŸ“¦ Banco de dados atualizando planos	âœ…
ğŸ“Š Logs sendo gravados (opcional)	âœ…
âš™ï¸ Sandbox desativado no ambiente de produÃ§Ã£o	âœ…